<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Netzwerk-Inventar — Infrastruktur-Übersicht</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Mono:wght@300;400;500&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;1,9..40,300&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0d1117;
      --surface: #161b22;
      --surface-2: #1c2330;
      --border: #21262d;
      --border-accent: #30363d;
      --text: #e6edf3;
      --text-muted: #7d8590;
      --text-subtle: #484f58;
      --accent: #58a6ff;
      --accent-dim: rgba(88,166,255,0.1);
      --accent-glow: rgba(88,166,255,0.2);
      --green: #3fb950;
      --green-dim: rgba(63,185,80,0.12);
      --orange: #d29922;
      --orange-dim: rgba(210,153,34,0.12);
      --purple: #bc8cff;
      --purple-dim: rgba(188,140,255,0.12);
      --red: #f85149;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'DM Sans', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }

    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background-image:
        linear-gradient(rgba(88,166,255,0.02) 1px, transparent 1px),
        linear-gradient(90deg, rgba(88,166,255,0.02) 1px, transparent 1px);
      background-size: 48px 48px;
      pointer-events: none;
      z-index: 0;
    }

    .page-wrap { position: relative; z-index: 1; }

    header {
      background: linear-gradient(180deg, #0d1117 0%, transparent 100%);
      border-bottom: 1px solid var(--border);
      padding: 28px 40px 24px;
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      gap: 20px;
      position: sticky;
      top: 0;
      z-index: 50;
      backdrop-filter: blur(12px);
    }

    .header-left { display: flex; align-items: center; gap: 14px; }

    .logo-mark {
      width: 40px; height: 40px;
      border: 1.5px solid var(--accent);
      border-radius: 8px;
      display: flex; align-items: center; justify-content: center;
      background: var(--accent-dim);
      box-shadow: 0 0 16px var(--accent-glow);
      flex-shrink: 0;
    }
    .logo-mark svg { width: 20px; height: 20px; }

    .header-title {
      font-family: 'DM Serif Display', serif;
      font-size: 1.4rem;
      color: var(--text);
      letter-spacing: -0.01em;
    }
    .header-subtitle {
      font-size: 0.72rem;
      color: var(--text-muted);
      letter-spacing: 0.06em;
      text-transform: uppercase;
      margin-top: 2px;
      font-family: 'DM Mono', monospace;
    }

    .scan-badge {
      font-family: 'DM Mono', monospace;
      font-size: 0.7rem;
      color: var(--text-muted);
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 5px 10px;
      letter-spacing: 0.04em;
    }
    .scan-badge span { color: var(--green); }

    .stats-row {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 12px;
      padding: 28px 40px 0;
      animation: fadeUp 0.5s ease both;
    }

    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(16px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .stat-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 16px;
      position: relative;
      overflow: hidden;
      transition: border-color 0.2s, transform 0.2s;
    }
    .stat-card:hover {
      border-color: var(--border-accent);
      transform: translateY(-2px);
    }
    .stat-card::after {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 2px;
      border-radius: 10px 10px 0 0;
    }
    .stat-card.blue::after  { background: var(--accent); }
    .stat-card.green::after { background: var(--green); }
    .stat-card.orange::after{ background: var(--orange); }
    .stat-card.purple::after{ background: var(--purple); }

    .stat-label {
      font-size: 0.68rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-family: 'DM Mono', monospace;
    }
    .stat-value {
      font-family: 'DM Serif Display', serif;
      font-size: 2rem;
      line-height: 1;
      margin-top: 6px;
    }
    .stat-card.blue   .stat-value { color: var(--accent); }
    .stat-card.green  .stat-value { color: var(--green); }
    .stat-card.orange .stat-value { color: var(--orange); }
    .stat-card.purple .stat-value { color: var(--purple); }
    .stat-sub {
      font-size: 0.7rem;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .main-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      padding: 20px 40px 40px;
      animation: fadeUp 0.6s ease 0.1s both;
    }

    .section-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
    }

    .section-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--surface-2);
    }
    .section-title {
      font-family: 'DM Serif Display', serif;
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .section-title svg { opacity: 0.6; }
    .badge {
      font-family: 'DM Mono', monospace;
      font-size: 0.68rem;
      background: var(--accent-dim);
      color: var(--accent);
      border: 1px solid rgba(88,166,255,0.2);
      border-radius: 20px;
      padding: 2px 8px;
    }

    .filter-bar {
      padding: 10px 16px;
      border-bottom: 1px solid var(--border);
      background: var(--bg);
    }
    .search-input {
      width: 100%;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-family: 'DM Mono', monospace;
      font-size: 0.75rem;
      padding: 6px 10px;
      outline: none;
      transition: border-color 0.2s;
    }
    .search-input:focus { border-color: var(--accent); }
    .search-input::placeholder { color: var(--text-subtle); }

    .table-wrap { overflow-y: auto; max-height: 480px; }

    table { width: 100%; border-collapse: collapse; font-size: 12.5px; }

    thead tr {
      background: var(--surface-2);
      position: sticky; top: 0; z-index: 5;
    }
    th {
      padding: 9px 14px;
      text-align: left;
      font-family: 'DM Mono', monospace;
      font-size: 0.65rem;
      font-weight: 500;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      white-space: nowrap;
      border-bottom: 1px solid var(--border);
    }

    tbody tr {
      border-bottom: 1px solid var(--border);
      transition: background 0.15s;
    }
    tbody tr:hover { background: rgba(88,166,255,0.04); }
    tbody tr:last-child { border-bottom: none; }

    td {
      padding: 9px 14px;
      vertical-align: middle;
      color: var(--text);
    }

    .mono {
      font-family: 'DM Mono', monospace;
      font-size: 11.5px;
      color: var(--accent);
    }
    .hostname-cell { font-weight: 500; }
    .unknown-text { color: var(--text-subtle); font-style: italic; font-size: 11px; }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-family: 'DM Mono', monospace;
      font-weight: 500;
      white-space: nowrap;
    }
    .chip-router   { background: rgba(88,166,255,0.12); color: var(--accent); border: 1px solid rgba(88,166,255,0.2); }
    .chip-nas      { background: rgba(188,140,255,0.12); color: var(--purple); border: 1px solid rgba(188,140,255,0.2); }
    .chip-audio    { background: rgba(63,185,80,0.12);  color: var(--green);  border: 1px solid rgba(63,185,80,0.2); }
    .chip-iot      { background: rgba(210,153,34,0.12); color: var(--orange); border: 1px solid rgba(210,153,34,0.2); }
    .chip-ha       { background: rgba(57,211,83,0.1);   color: #39d353;       border: 1px solid rgba(57,211,83,0.2); }
    .chip-pihole   { background: rgba(248,81,73,0.12);  color: var(--red);    border: 1px solid rgba(248,81,73,0.2); }
    .chip-default  { background: var(--surface-2);       color: var(--text-muted); border: 1px solid var(--border); }
    .chip-unknown  { background: transparent;             color: var(--text-subtle); border: 1px dashed var(--border); }

    .stack-chip {
      display: inline-block;
      padding: 1px 6px;
      border-radius: 3px;
      font-size: 10.5px;
      font-family: 'DM Mono', monospace;
      background: var(--purple-dim);
      color: var(--purple);
      border: 1px solid rgba(188,140,255,0.15);
      white-space: nowrap;
    }
    .port-tag {
      display: inline-block;
      font-family: 'DM Mono', monospace;
      font-size: 10.5px;
      background: var(--green-dim);
      color: var(--green);
      border: 1px solid rgba(63,185,80,0.15);
      border-radius: 3px;
      padding: 1px 5px;
      margin: 1px 2px 1px 0;
    }
    .ports-cell { line-height: 1.8; }

    .img-cell {
      font-family: 'DM Mono', monospace;
      font-size: 10.5px;
      color: var(--text-muted);
      max-width: 200px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .full-width { grid-column: 1 / -1; }

    .stacks-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 10px;
      padding: 16px;
    }
    .stack-block {
      background: var(--surface-2);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      transition: border-color 0.2s, background 0.2s, box-shadow 0.2s;
      cursor: pointer;
      user-select: none;
    }
    .stack-block:hover { border-color: var(--border-accent); }
    .stack-block.active {
      border-color: var(--purple);
      background: var(--purple-dim);
      box-shadow: 0 0 0 1px rgba(188,140,255,0.2);
    }
    .stat-card { cursor: pointer; transition: border-color 0.2s, transform 0.2s, box-shadow 0.2s; }
    .stat-card.blue.active   { box-shadow: 0 0 0 2px var(--accent),  0 0 18px var(--accent-glow); }
    .stat-card.green.active  { box-shadow: 0 0 0 2px var(--green),   0 0 18px rgba(63,185,80,0.25); }
    .stat-card.orange.active { box-shadow: 0 0 0 2px var(--orange),  0 0 18px rgba(210,153,34,0.25); }
    .stat-card.purple.active { box-shadow: 0 0 0 2px var(--purple),  0 0 18px rgba(188,140,255,0.25); }
    .filter-hint {
      font-family: 'DM Mono', monospace;
      font-size: 0.65rem;
      color: var(--text-subtle);
      padding: 4px 16px 2px;
      letter-spacing: 0.04em;
    }
    .filter-hint .hl-purple { color: var(--purple); }
    .filter-hint .hl-blue   { color: var(--accent); }
    .stack-name {
      font-family: 'DM Serif Display', serif;
      font-size: 0.9rem;
      color: var(--text);
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .stack-count {
      font-family: 'DM Mono', monospace;
      font-size: 0.65rem;
      color: var(--text-muted);
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 0 6px;
    }
    .stack-services {
      list-style: none;
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }
    .stack-service-item {
      font-family: 'DM Mono', monospace;
      font-size: 10px;
      color: var(--text-muted);
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 3px;
      padding: 1px 5px;
    }

    footer {
      text-align: center;
      padding: 20px 40px;
      color: var(--text-subtle);
      font-size: 0.7rem;
      font-family: 'DM Mono', monospace;
      border-top: 1px solid var(--border);
      letter-spacing: 0.04em;
    }

    @media (max-width: 900px) {
      .stats-row { grid-template-columns: repeat(3, 1fr); }
      .main-content { grid-template-columns: 1fr; }
      header { padding: 18px 20px; flex-direction: column; align-items: flex-start; }
      .stats-row, .main-content { padding-left: 20px; padding-right: 20px; }
    }
  </style>
</head>
<body>
<div class="page-wrap">

  <header>
    <div class="header-left">
      <div class="logo-mark">
        <svg viewBox="0 0 24 24" fill="none" stroke="#58a6ff" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
          <rect x="2" y="2" width="8" height="8" rx="1.5"/>
          <rect x="14" y="2" width="8" height="8" rx="1.5"/>
          <rect x="2" y="14" width="8" height="8" rx="1.5"/>
          <rect x="14" y="14" width="8" height="8" rx="1.5"/>
        </svg>
      </div>
      <div>
        <div class="header-title">Infrastruktur-Übersicht</div>
        <div class="header-subtitle">Netzwerk &amp; Container Inventar · 192.168.0.x</div>
      </div>
    </div>
    <div class="scan-badge" id="scan-timestamp-badge"><span>●</span> <span id="scan-timestamp">Lade Daten …</span></div>
  </header>

  <div class="stats-row" id="stats-row"></div>

  <div class="main-content">
    <div class="section-card">
      <div class="section-header">
        <div class="section-title">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/>
            <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
          </svg>
          Netzwerk-Geräte
        </div>
        <span class="badge" id="net-badge">—</span>
      </div>
      <div class="filter-bar">
        <input class="search-input" type="text" id="net-search" placeholder="Filtern nach IP, Hostname, Typ…" oninput="onNetSearch(this.value)" />
      </div>
      <div class="filter-hint" id="net-filter-hint" style="display:none">Aktiver Typ-Filter: <span class="hl-blue" id="net-filter-label"></span> &nbsp;·&nbsp; Klick zum Aufheben</div>
      <div class="table-wrap">
        <table>
          <thead><tr><th>IP-Adresse</th><th>Hostname</th><th>Gerätetyp</th></tr></thead>
          <tbody id="devices-tbody"></tbody>
        </table>
      </div>
    </div>

    <div class="section-card">
      <div class="section-header">
        <div class="section-title">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
          </svg>
          Docker-Container
        </div>
        <span class="badge" id="docker-badge">—</span>
      </div>
      <div class="filter-bar">
        <input class="search-input" type="text" id="docker-search" placeholder="Filtern nach Name, Image, Stack, Port…" oninput="onDockerSearch(this.value)" />
      </div>
      <div class="filter-hint" id="docker-filter-hint" style="display:none">Aktiver Stack-Filter: <span class="hl-purple" id="docker-filter-label"></span> &nbsp;·&nbsp; Klick auf Stack zum Aufheben</div>
      <div class="table-wrap">
        <table>
          <thead><tr><th>Container</th><th>Image</th><th>Ports</th><th>Stack</th></tr></thead>
          <tbody id="containers-tbody"></tbody>
        </table>
      </div>
    </div>

    <div class="section-card full-width">
      <div class="section-header">
        <div class="section-title">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
          </svg>
          Stack-Gruppen
        </div>
        <span class="badge" id="stacks-badge">—</span>
      </div>
      <div class="stacks-grid" id="stacks-grid"></div>
    </div>
  </div>

  <footer>netscope · Netzwerk &amp; Container Inventar · <span id="scan-timestamp" style="color:var(--text-muted)"></span></footer>
</div>

<div id="load-status" style="
  position:fixed; bottom:24px; right:24px;
  background:var(--surface); border:1px solid var(--border);
  border-radius:8px; padding:10px 16px;
  font-family:'DM Mono',monospace; font-size:0.75rem;
  color:var(--text-muted); z-index:100;
  box-shadow:0 4px 16px rgba(0,0,0,0.3);">
  ⏳ Lade JSON-Daten …
</div>
<script>
// ── netscope – live fetch mode ────────────────────────────────────────────
// Lädt JSON-Daten beim Seitenaufruf direkt vom Server.
// Dateien erwartet im selben Verzeichnis wie die HTML:
//   network_devices.json
//   docker_containers.json

let NETWORK_DEVICES   = [];
let DOCKER_CONTAINERS = [];

async function loadData() {
  const statusEl = document.getElementById('load-status');

  async function fetchJSON(path) {
    const r = await fetch(path);
    if (!r.ok) throw new Error(`${path}: HTTP ${r.status}`);
    return r.json();
  }

  try {
    [NETWORK_DEVICES, DOCKER_CONTAINERS] = await Promise.all([
      fetchJSON('network_devices.json'),
      fetchJSON('docker_containers.json'),
    ]);
    statusEl.style.display = 'none';
    renderStats();
    renderDevices();
    renderContainers();
    renderStacks();
    // Zeitstempel aus den Daten lesen
    if (NETWORK_DEVICES.length > 0 && NETWORK_DEVICES[0].scan) {
      const raw = NETWORK_DEVICES[0].scan;
      document.getElementById('scan-timestamp').textContent = 'Scan: ' + raw;
    }
  } catch(err) {
    statusEl.innerHTML = `<span style="color:var(--red)">⚠ Fehler beim Laden: ${err.message}</span>`;
    statusEl.style.display = 'block';
    console.error(err);
  }
}

// ── State ──────────────────────────────────────────────────────────────────
let activeStacks   = new Set(); // selected stack names
let activeDevType  = null;      // selected device type from stat card
let dockerSearchQ  = '';
let netSearchQ     = '';

// ── Helpers ────────────────────────────────────────────────────────────────
function deviceChip(type) {
  const map = {
    'Router/Gateway': 'chip-router',
    'NAS':            'chip-nas',
    'Audio':          'chip-audio',
    'IoT':            'chip-iot',
    'Home Assistant': 'chip-ha',
    'Pi-hole':        'chip-pihole',
    'Unknown':        'chip-unknown',
    'Network Device': 'chip-default',
  };
  return `<span class="chip ${map[type] || 'chip-default'}">${type}</span>`;
}

function parsePorts(portsStr) {
  if (!portsStr) return '<span style="color:var(--text-subtle);font-size:10px">—</span>';
  const matches = [...portsStr.matchAll(/-> 0[.]0[.]0[.]0:([0-9]+)/g)];
  if (!matches.length) return '<span style="color:var(--text-subtle);font-size:10px">—</span>';
  return matches.map(m => `<span class="port-tag">:${m[1]}</span>`).join('');
}

function shortImage(img) {
  return img.replace(/^(ghcr[.]io|docker[.]io|lscr[.]io|gcr[.]io|quay[.]io)[/]/, '')
            .replace(/@sha256:[a-f0-9]+/, '');
}

function shortName(name) {
  return name.replace(/-1$/, '').replace(/^[a-z]+-/, '');
}

// ── Render Devices ─────────────────────────────────────────────────────────
function renderDevices() {
  document.getElementById('devices-tbody').innerHTML = NETWORK_DEVICES.map(d => `
    <tr data-devtype="${d.device}">
      <td><span class="mono">${d.ip}</span></td>
      <td>${d.hostname === 'N/A' ? '<span class="unknown-text">unbekannt</span>' : `<span class="hostname-cell">${d.hostname}</span>`}</td>
      <td>${deviceChip(d.device)}</td>
    </tr>`).join('');
  document.getElementById('net-badge').textContent = NETWORK_DEVICES.length + ' Geräte';
  applyNetFilter();
}

// ── Render Containers ──────────────────────────────────────────────────────
function renderContainers() {
  document.getElementById('containers-tbody').innerHTML = DOCKER_CONTAINERS.map(d => `
    <tr data-stack="${d.stack || ''}">
      <td><span class="hostname-cell">${d.name}</span></td>
      <td class="img-cell" title="${d.image}">${shortImage(d.image)}</td>
      <td class="ports-cell">${parsePorts(d.ports)}</td>
      <td>${d.stack ? `<span class="stack-chip">${d.stack}</span>` : '<span style="color:var(--text-subtle);font-size:10px">—</span>'}</td>
    </tr>`).join('');
  document.getElementById('docker-badge').textContent = DOCKER_CONTAINERS.length + ' Container';
  applyDockerFilter();
}

// ── Render Stacks ──────────────────────────────────────────────────────────
function renderStacks() {
  const stackMap = {};
  DOCKER_CONTAINERS.forEach(c => {
    const s = c.stack || '(standalone)';
    if (!stackMap[s]) stackMap[s] = [];
    stackMap[s].push(c.name);
  });
  const sorted = Object.entries(stackMap).sort((a,b) => b[1].length - a[1].length);
  document.getElementById('stacks-grid').innerHTML = sorted.map(([name, services]) => `
    <div class="stack-block" data-stack="${name}" onclick="toggleStack(event, '${name}')">
      <div class="stack-name">${name}<span class="stack-count">${services.length}</span></div>
      <ul class="stack-services">${services.map(s => `<li class="stack-service-item">${shortName(s)}</li>`).join('')}</ul>
    </div>`).join('');
  document.getElementById('stacks-badge').textContent = sorted.length + ' Stacks';
}

// ── Render Stats ───────────────────────────────────────────────────────────
function renderStats() {
  const deviceTypes = {};
  NETWORK_DEVICES.forEach(d => { deviceTypes[d.device] = (deviceTypes[d.device]||0)+1; });
  const stackCount = new Set(DOCKER_CONTAINERS.filter(c=>c.stack).map(c=>c.stack)).size;
  const withPorts  = DOCKER_CONTAINERS.filter(c => c.ports).length;

  // Which stat cards should be filterable by device type?
  const statDeviceType = [null, null, null, null, 'IoT', 'Unknown'];

  const stats = [
    { label: 'Netzwerk-Geräte',  value: NETWORK_DEVICES.length,   sub: 'Aktive Hosts',      cls: 'blue',   devtype: null },
    { label: 'Docker-Container', value: DOCKER_CONTAINERS.length,  sub: 'Laufende Container', cls: 'green',  devtype: null },
    { label: 'Stacks',           value: stackCount,                 sub: 'Compose-Gruppen',   cls: 'purple', devtype: null },
    { label: 'Exponierte Ports', value: withPorts,                  sub: 'Mit Port-Mapping',  cls: 'orange', devtype: null },
    { label: 'IoT-Geräte',       value: deviceTypes['IoT']||0,      sub: 'Shelly & Co.',      cls: 'orange', devtype: 'IoT' },
    { label: 'Unbekannte Hosts', value: deviceTypes['Unknown']||0,  sub: 'Ohne Hostname',     cls: 'blue',   devtype: 'Unknown' },
  ];

  document.getElementById('stats-row').innerHTML = stats.map(s => {
    const clickable = s.devtype ? `onclick="toggleDevType('${s.devtype}', this)"` : '';
    const title     = s.devtype ? `title="Klicken zum Filtern nach ${s.devtype}"` : '';
    return `
    <div class="stat-card ${s.cls}" data-devtype="${s.devtype||''}" ${clickable} ${title}>
      <div class="stat-label">${s.label}</div>
      <div class="stat-value">${s.value}</div>
      <div class="stat-sub">${s.sub}</div>
    </div>`;
  }).join('');
}

// ── Stack filter logic ─────────────────────────────────────────────────────
function toggleStack(event, stackName) {
  if (event.ctrlKey || event.metaKey) {
    // Multi-select
    if (activeStacks.has(stackName)) {
      activeStacks.delete(stackName);
    } else {
      activeStacks.add(stackName);
    }
  } else {
    // Single-select / toggle
    if (activeStacks.size === 1 && activeStacks.has(stackName)) {
      activeStacks.clear();
    } else {
      activeStacks.clear();
      activeStacks.add(stackName);
    }
  }
  updateStackUI();
  applyDockerFilter();
}

function updateStackUI() {
  document.querySelectorAll('.stack-block').forEach(el => {
    el.classList.toggle('active', activeStacks.has(el.dataset.stack));
  });
  const hint  = document.getElementById('docker-filter-hint');
  const label = document.getElementById('docker-filter-label');
  if (activeStacks.size > 0) {
    hint.style.display = 'block';
    label.textContent  = [...activeStacks].join(', ');
  } else {
    hint.style.display = 'none';
  }
  // Update docker badge with visible count
  const visible = document.querySelectorAll('#containers-tbody tr:not([style*="display: none"])').length;
  const total   = DOCKER_CONTAINERS.length;
  document.getElementById('docker-badge').textContent =
    activeStacks.size > 0 ? `${visible} / ${total} Container` : `${total} Container`;
}

// ── Device type filter (stat cards) ───────────────────────────────────────
function toggleDevType(devtype, cardEl) {
  if (activeDevType === devtype) {
    activeDevType = null;
    cardEl.classList.remove('active');
  } else {
    // Deactivate any previously active stat card
    document.querySelectorAll('.stat-card.active').forEach(c => c.classList.remove('active'));
    activeDevType = devtype;
    cardEl.classList.add('active');
  }
  const hint  = document.getElementById('net-filter-hint');
  const label = document.getElementById('net-filter-label');
  if (activeDevType) {
    hint.style.display = 'block';
    label.textContent  = activeDevType;
  } else {
    hint.style.display = 'none';
  }
  applyNetFilter();
}

// ── Apply Docker filter (stacks + search) ──────────────────────────────────
function applyDockerFilter() {
  const q = dockerSearchQ.toLowerCase();
  document.querySelectorAll('#containers-tbody tr').forEach(row => {
    const stackMatch = activeStacks.size === 0 || activeStacks.has(row.dataset.stack || '');
    const textMatch  = !q || row.textContent.toLowerCase().includes(q);
    row.style.display = (stackMatch && textMatch) ? '' : 'none';
  });
  // update badge after filter
  const visible = [...document.querySelectorAll('#containers-tbody tr')].filter(r => r.style.display !== 'none').length;
  const total   = DOCKER_CONTAINERS.length;
  document.getElementById('docker-badge').textContent =
    (activeStacks.size > 0 || q) ? `${visible} / ${total} Container` : `${total} Container`;
}

// ── Apply Network filter (devtype + search) ────────────────────────────────
function applyNetFilter() {
  const q = netSearchQ.toLowerCase();
  document.querySelectorAll('#devices-tbody tr').forEach(row => {
    const typeMatch = !activeDevType || row.dataset.devtype === activeDevType;
    const textMatch = !q || row.textContent.toLowerCase().includes(q);
    row.style.display = (typeMatch && textMatch) ? '' : 'none';
  });
  const visible = [...document.querySelectorAll('#devices-tbody tr')].filter(r => r.style.display !== 'none').length;
  const total   = NETWORK_DEVICES.length;
  document.getElementById('net-badge').textContent =
    (activeDevType || q) ? `${visible} / ${total} Geräte` : `${total} Geräte`;
}

// ── Search input handlers ──────────────────────────────────────────────────
function onDockerSearch(val) {
  dockerSearchQ = val;
  applyDockerFilter();
}

function onNetSearch(val) {
  netSearchQ = val;
  applyNetFilter();
}

loadData();

</script>
</body>
</html>